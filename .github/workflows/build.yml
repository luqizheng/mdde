name: Build and Release

on:
  push:
    branches: [ main, develop ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main ]

env:
  CARGO_TERM_COLOR: always

jobs:
  build:
    name: Build ${{ matrix.target }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          # Linux x64
          - target: x86_64-unknown-linux-gnu
            os: ubuntu-latest
            binary-name: mdde
            asset-name: mdde-linux-x64
            
          # Windows x64
          - target: x86_64-pc-windows-msvc
            os: windows-latest
            binary-name: mdde.exe
            asset-name: mdde-windows-x64.exe
            
          # macOS Intel
          - target: x86_64-apple-darwin
            os: macos-latest
            binary-name: mdde
            asset-name: mdde-macos-x64
            
          # macOS Apple Silicon
          - target: aarch64-apple-darwin
            os: macos-latest
            binary-name: mdde
            asset-name: mdde-macos-arm64

    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: å®‰è£… Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        targets: ${{ matrix.target }}

    - name: é…ç½® Rust ç¼“å­˜
      uses: Swatinem/rust-cache@v2
      with:
        workspaces: "mdde-cmd -> target"
        key: ${{ matrix.target }}

    - name: å®‰è£… Linux ä¾èµ–
      if: matrix.os == 'ubuntu-latest'
      run: |
        sudo apt-get update
        sudo apt-get install -y pkg-config libssl-dev

    - name: æ„å»ºé¡¹ç›®
      working-directory: mdde-cmd
      run: |
        cargo build --release --target ${{ matrix.target }}

    - name: å‡†å¤‡å‘å¸ƒæ–‡ä»¶
      shell: bash
      run: |
        mkdir -p release-builds/${{ matrix.target }}
        if [ "${{ matrix.os }}" = "windows-latest" ]; then
          cp mdde-cmd/target/${{ matrix.target }}/release/${{ matrix.binary-name }} release-builds/${{ matrix.target }}/
        else
          cp mdde-cmd/target/${{ matrix.target }}/release/${{ matrix.binary-name }} release-builds/${{ matrix.target }}/
          chmod +x release-builds/${{ matrix.target }}/${{ matrix.binary-name }}
        fi

    - name: ä¸Šä¼ æ„å»ºäº§ç‰©
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.asset-name }}
        path: release-builds/${{ matrix.target }}/${{ matrix.binary-name }}
        retention-days: 30

  # è¿è¡Œæµ‹è¯•
  test:
    name: è¿è¡Œæµ‹è¯•
    runs-on: ubuntu-latest
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: å®‰è£… Rust
      uses: dtolnay/rust-toolchain@stable

    - name: é…ç½® Rust ç¼“å­˜
      uses: Swatinem/rust-cache@v2
      with:
        workspaces: "mdde-cmd -> target"

    - name: å®‰è£…ä¾èµ–
      run: |
        sudo apt-get update
        sudo apt-get install -y pkg-config libssl-dev

    - name: è¿è¡Œæµ‹è¯•
      working-directory: mdde-cmd
      run: cargo test --verbose

    - name: è¿è¡Œ Clippy
      working-directory: mdde-cmd
      run: cargo clippy -- -D warnings

    - name: æ£€æŸ¥æ ¼å¼
      working-directory: mdde-cmd
      run: cargo fmt -- --check

  # åˆ›å»ºå‘å¸ƒç‰ˆæœ¬
  release:
    name: åˆ›å»ºå‘å¸ƒç‰ˆæœ¬
    needs: [build, test]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: ä¸‹è½½æ‰€æœ‰æ„å»ºäº§ç‰©
      uses: actions/download-artifact@v4
      with:
        path: artifacts

    - name: å‡†å¤‡å‘å¸ƒæ–‡ä»¶
      run: |
        mkdir -p release-assets
        
        # Linux x64
        cp artifacts/mdde-linux-x64/mdde release-assets/mdde-linux-x64
        chmod +x release-assets/mdde-linux-x64
        
        # Windows x64
        cp artifacts/mdde-windows-x64.exe/mdde.exe release-assets/mdde-windows-x64.exe
        
        # macOS Intel
        cp artifacts/mdde-macos-x64/mdde release-assets/mdde-macos-x64
        chmod +x release-assets/mdde-macos-x64
        
        # macOS Apple Silicon
        cp artifacts/mdde-macos-arm64/mdde release-assets/mdde-macos-arm64
        chmod +x release-assets/mdde-macos-arm64

    - name: åˆ›å»ºå‹ç¼©åŒ…
      run: |
        cd release-assets
        
        # Linux
        tar -czf mdde-linux-x64.tar.gz mdde-linux-x64
        
        # Windows
        zip mdde-windows-x64.zip mdde-windows-x64.exe
        
        # macOS Intel
        tar -czf mdde-macos-x64.tar.gz mdde-macos-x64
        
        # macOS Apple Silicon
        tar -czf mdde-macos-arm64.tar.gz mdde-macos-arm64

    - name: è·å–ç‰ˆæœ¬ä¿¡æ¯
      id: get_version
      run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

    - name: åˆ›å»º Release
      uses: softprops/action-gh-release@v1
      with:
        name: MDDE ${{ steps.get_version.outputs.VERSION }}
        draft: false
        prerelease: false
        generate_release_notes: true
        files: |
          release-assets/mdde-linux-x64.tar.gz
          release-assets/mdde-windows-x64.zip
          release-assets/mdde-macos-x64.tar.gz
          release-assets/mdde-macos-arm64.tar.gz
          release-assets/mdde-linux-x64
          release-assets/mdde-windows-x64.exe
          release-assets/mdde-macos-x64
          release-assets/mdde-macos-arm64
        body: |
          ## ğŸš€ MDDE ${{ steps.get_version.outputs.VERSION }} å‘å¸ƒ

          ### ğŸ“¦ ä¸‹è½½é“¾æ¥
          
          **Linux (x64)**
          - äºŒè¿›åˆ¶æ–‡ä»¶: [mdde-linux-x64](https://github.com/${{ github.repository }}/releases/download/${{ steps.get_version.outputs.VERSION }}/mdde-linux-x64)
          - å‹ç¼©åŒ…: [mdde-linux-x64.tar.gz](https://github.com/${{ github.repository }}/releases/download/${{ steps.get_version.outputs.VERSION }}/mdde-linux-x64.tar.gz)
          
          **Windows (x64)**
          - äºŒè¿›åˆ¶æ–‡ä»¶: [mdde-windows-x64.exe](https://github.com/${{ github.repository }}/releases/download/${{ steps.get_version.outputs.VERSION }}/mdde-windows-x64.exe)
          - å‹ç¼©åŒ…: [mdde-windows-x64.zip](https://github.com/${{ github.repository }}/releases/download/${{ steps.get_version.outputs.VERSION }}/mdde-windows-x64.zip)
          
          **macOS (Intel)**
          - äºŒè¿›åˆ¶æ–‡ä»¶: [mdde-macos-x64](https://github.com/${{ github.repository }}/releases/download/${{ steps.get_version.outputs.VERSION }}/mdde-macos-x64)
          - å‹ç¼©åŒ…: [mdde-macos-x64.tar.gz](https://github.com/${{ github.repository }}/releases/download/${{ steps.get_version.outputs.VERSION }}/mdde-macos-x64.tar.gz)
          
          **macOS (Apple Silicon)**
          - äºŒè¿›åˆ¶æ–‡ä»¶: [mdde-macos-arm64](https://github.com/${{ github.repository }}/releases/download/${{ steps.get_version.outputs.VERSION }}/mdde-macos-arm64)
          - å‹ç¼©åŒ…: [mdde-macos-arm64.tar.gz](https://github.com/${{ github.repository }}/releases/download/${{ steps.get_version.outputs.VERSION }}/mdde-macos-arm64.tar.gz)

          ### ğŸ› ï¸ å®‰è£…è¯´æ˜
          
          1. ä¸‹è½½å¯¹åº”å¹³å°çš„äºŒè¿›åˆ¶æ–‡ä»¶
          2. å°†æ–‡ä»¶é‡å‘½åä¸º `mdde` (Windows ä¿æŒ `.exe` æ‰©å±•å)
          3. å°†æ–‡ä»¶ç§»åŠ¨åˆ° PATH ç¯å¢ƒå˜é‡ä¸­çš„ç›®å½•
          4. åœ¨ç»ˆç«¯ä¸­è¿è¡Œ `mdde --help` éªŒè¯å®‰è£…

          ### ğŸ“‹ æ›´æ–°æ—¥å¿—
          
          è¯¦ç»†æ›´æ–°å†…å®¹è¯·æŸ¥çœ‹ä¸‹æ–¹çš„è‡ªåŠ¨ç”Ÿæˆçš„å‘å¸ƒè¯´æ˜ã€‚
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
